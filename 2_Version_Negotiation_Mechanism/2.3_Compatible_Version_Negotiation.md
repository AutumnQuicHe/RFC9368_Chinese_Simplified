---
title: "2.3. 兼容版本协商"
anchor: "2.3_Compatible_Version_Negotiation"
weight: 230
rank: "h2"
---

当服务端能够使用客户端的选择版本解析客户端的首飞，则其可以提取客户端的版本信息结构（详见[第3章]()）。
这包含客户端所知道的且兼容其首飞的各个版本的列表。

为了实施兼容版本协商，服务端{{< req_level MUST >}}选择其中一个（1）其支持且（2）知道的与客户端**选择版本**兼容的版本。
该选择版本即当前的**协商版本**。
在选择了协商版本后，服务端试图将客户端首飞转换成该版本，并回复客户端，就像其先前收到转换的首飞那样。


如果这些格式完全一致，例如协商版本与客户端的选择版本相同，则这将是恒等转换。
如果首发格式正确，则该转换过程不能通过定义兼容首飞的方式失败；如果服务端不能转换首飞，则其{{< req_level MUST >}}中止握手。


如果某份文档指定的QUIC版本兼容其他版本，则该文档{{< req_level MUST >}}指定一个使其客户端知晓该协商版本的机制。
这种机制的一个例子是让客户端通过考察QUIC长包头的版本字段来确认服务端的协商版本。
注意，在该示例机制中，可以让服务端在切换到协商版本前，先使用客户端的**选择版本**发送数据包（这种情况可能发生在当客户端的版本信息结构包含多个数据包；此时，服务端可能确认的首个数据包是客户端的**选择版本**，随后切换到一个不同的协商版本）。
相互地，兼容版本{{< req_level SHOULD >}}使用相同的机制。


Note that, after the first flight is converted to the Negotiated Version, the handshake completes in the Negotiated Version. If the Negotiated Version has requirements that apply during the handshake, those requirements apply to the entire handshake, including the converted first flight. In particular, if the Negotiated Version mandates that endpoints perform validations on Handshake packets, endpoints MUST also perform such validations on the converted first flight. For instance, if the Negotiated Version requires that the 5-tuple remain stable for the entire handshake (as QUIC version 1 does), then both endpoints need to validate the 5-tuple of all packets received during the handshake, including the converted first flight.

Note also that the client can disable compatible version negotiation by only including the Chosen Version in the Available Versions field of the Version Information (see Section 3).

If the server does not find a compatible version (including the client's Chosen Version), it will perform incompatible version negotiation instead (see Section 2.1).

Note that it is possible to have incompatible version negotiation followed by compatible version negotiation. For instance, if version A is compatible with version B and version C is compatible with version D, the following scenario could occur:



```
Client                                          Server

Chosen = A, Available Versions = (A, B) ------------->
<------------------------ Version Negotiation = (D, C)

Chosen = C, Available Versions = (C, D) ------------->
<------------- Chosen = D, Available Versions = (D, C)

Figure 1: Combined Negotiation Example
```


In this example, the client selected C from the server's Version Negotiation packet, but the server preferred D and then selected it from the client's offer.
